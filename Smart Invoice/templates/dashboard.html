<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Invoice Analytics</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: var(--primary-gradient) !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }
        
        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
            color: white;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .btn-delete {
            background: var(--warning-gradient);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 0.25rem 0.75rem;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .search-box input {
            padding-left: 45px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a href="/" class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line me-2"></i>Smart Invoice Analytics
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/reports">
                            <i class="fas fa-chart-bar me-1"></i>Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/vendors">
                            <i class="fas fa-building me-1"></i>Vendors
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">
                            <i class="fas fa-cog me-1"></i>Settings
                        </a>
                    </li>
                </ul>
                <div class="navbar-nav">
                    <span class="nav-link" id="currentTime"></span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--primary-gradient);">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <h3 class="mb-1" id="totalInvoices">0</h3>
                    <p class="text-muted mb-0">Total Invoices</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success-gradient);">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3 class="mb-1" id="totalAmount">$0</h3>
                    <p class="text-muted mb-0">Total Amount</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--success-gradient);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="mb-1" id="paidCount">0</h3>
                    <p class="text-muted mb-0">Paid</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning-gradient);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3 class="mb-1" id="pendingCount">0</h3>
                    <p class="text-muted mb-0">Pending</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--warning-gradient);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="mb-1" id="overdueCount">0</h3>
                    <p class="text-muted mb-0">Overdue</p>
                </div>
            </div>
            <div class="col-md-2">
                <div class="stat-card">
                    <div class="stat-icon" style="background: var(--info-gradient);">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <h3 class="mb-1" id="avgAmount">$0</h3>
                    <p class="text-muted mb-0">Average</p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Input Section -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Invoice</h5>
                    </div>
                    <div class="card-body">
                        <form id="invoiceForm">
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vendor</label>
                                <input type="text" class="form-control" id="vendor" placeholder="Company Name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amount ($)</label>
                                <input type="number" step="0.01" class="form-control" id="amount" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status" required>
                                    <option value="paid">✅ Paid</option>
                                    <option value="pending">⏳ Pending</option>
                                    <option value="overdue">⚠️ Overdue</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-gradient w-100">
                                <i class="fas fa-save me-2"></i>Add Invoice
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload CSV/Excel</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="file" accept=".csv,.xlsx" required>
                                <div class="form-text">Supported formats: CSV, Excel</div>
                            </div>
                            <button type="submit" class="btn btn-gradient w-100">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload File
                            </button>
                        </form>
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Required columns:</strong> date, vendor, amount, status
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Financial Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="aiSummary" class="alert alert-info">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-building me-2"></i>Top Vendors</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="vendorChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Invoice Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Recent Invoices</h5>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" class="form-control" id="searchInput" placeholder="Search invoices...">
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Vendor</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
        
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadStats();
            loadAnalytics();
            loadInvoices();
            loadSummary();
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString();
        }

        function showToast(type, message) {
            const toast = type === 'success' ? 
                new bootstrap.Toast(document.getElementById('successToast')) :
                new bootstrap.Toast(document.getElementById('errorToast'));
            
            document.getElementById(type + 'Message').textContent = message;
            toast.show();
        }

        // Add invoice form
        document.getElementById('invoiceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('date', document.getElementById('date').value);
            formData.append('vendor', document.getElementById('vendor').value);
            formData.append('amount', document.getElementById('amount').value);
            formData.append('status', document.getElementById('status').value);

            try {
                const response = await fetch('/add-invoice/', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (response.ok) {
                    showToast('success', result.message);
                    document.getElementById('invoiceForm').reset();
                    refreshData();
                } else {
                    showToast('error', result.detail);
                }
            } catch (error) {
                showToast('error', 'Error adding invoice');
            }
        });

        // Upload file form
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file');
            
            if (!fileInput.files[0]) {
                showToast('error', 'Please select a file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/upload/', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Upload failed');
                }
                
                const result = await response.json();
                showToast('success', result.message);
                document.getElementById('uploadForm').reset();
                refreshData();
            } catch (error) {
                showToast('error', 'Error uploading file: ' + error.message);
            }
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#invoiceTable tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();
                
                document.getElementById('totalInvoices').textContent = stats.total_invoices;
                document.getElementById('totalAmount').textContent = '$' + stats.total_amount.toLocaleString();
                document.getElementById('paidCount').textContent = stats.paid_count;
                document.getElementById('pendingCount').textContent = stats.pending_count;
                document.getElementById('overdueCount').textContent = stats.overdue_count;
                document.getElementById('avgAmount').textContent = '$' + stats.avg_amount.toLocaleString();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/analytics');
                const data = await response.json();

                // Top vendors chart
                if (data.top_vendors && Object.keys(data.top_vendors).length > 0) {
                    const ctx = document.getElementById('vendorChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(data.top_vendors),
                            datasets: [{
                                label: 'Amount ($)',
                                data: Object.values(data.top_vendors),
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2,
                                borderRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }

                // Status chart
                if (data.status_breakdown && Object.keys(data.status_breakdown).length > 0) {
                    const ctx2 = document.getElementById('statusChart').getContext('2d');
                    new Chart(ctx2, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(data.status_breakdown),
                            datasets: [{
                                data: Object.values(data.status_breakdown),
                                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadInvoices() {
            try {
                const response = await fetch('/invoices');
                const invoices = await response.json();
                
                const tbody = document.getElementById('invoiceTable');
                tbody.innerHTML = '';
                
                invoices.forEach(invoice => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${invoice.date}</td>
                        <td><i class="fas fa-building me-2"></i>${invoice.vendor}</td>
                        <td><strong>$${invoice.amount.toLocaleString()}</strong></td>
                        <td><span class="badge bg-${getStatusColor(invoice.status)}">${getStatusIcon(invoice.status)} ${invoice.status}</span></td>
                        <td>
                            <button class="btn btn-delete btn-sm" onclick="deleteInvoice(${invoice.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }

        async function loadSummary() {
            try {
                const response = await fetch('/summary');
                const data = await response.json();
                document.getElementById('aiSummary').innerHTML = `<i class="fas fa-lightbulb me-2"></i>${data.summary}`;
            } catch (error) {
                document.getElementById('aiSummary').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Unable to generate summary';
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice?')) return;
            
            try {
                const response = await fetch(`/invoices/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (response.ok) {
                    showToast('success', result.message);
                    refreshData();
                } else {
                    showToast('error', result.detail);
                }
            } catch (error) {
                showToast('error', 'Error deleting invoice');
            }
        }

        function refreshData() {
            loadStats();
            loadAnalytics();
            loadInvoices();
            loadSummary();
        }

        function getStatusColor(status) {
            switch(status) {
                case 'paid': return 'success';
                case 'pending': return 'warning';
                case 'overdue': return 'danger';
                default: return 'secondary';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'paid': return '✅';
                case 'pending': return '⏳';
                case 'overdue': return '⚠️';
                default: return '📄';
            }
        }
    </script>
</body>
</html>